# Оглавление 
    1. Описние шаблона
    2. Информация о проверяемом XML
    3. Основная концепция проверки
    4. Содержание шаблона
    5. Установка
    6. Использование


## 1. Описние шаблона
    1.1. Шаблон предназначен для организации проверки корректности данных итогового XML, а также его формата.

    1.2. Шаблон представляет структуру пайтон модулей для загрузки проверяемых отчетов а 
         также отчетов, выступающих в роли эталона данных. Данные модули пустые и их 
        необходимо заполнить. 
            - В пакете "public_reports" содержаться модули для загрузки и проверки 
            отчетов, проверка которых является основной целью данного Шаблона.
            - В пакете "external_reports" содержаться модули для загрузки отчетов с 
            эталоннымы данными для проверки отчетов из "public_reports"
            - В пакете "sistem_reports" содержаться модули для загрузки отчетов, 
            сгенерированных финансово расчетной системой, либо для загрузки данных из БД системы

    1.3. Для удобства и упрощения зугрузки отчетов с данными, их сверки с эталонными 
        данными, сохранения результатов, в шаблоне реализованы 
        Специальные функции\инструменты в пакете 'project_tools'.

    1.4. Также в шаблоне:
            - организовано введение расчетного месяца, 
            - предусмотрен выбор одной из копий финансово расчетной системы \ занесение тестовой папки
            - предусмотрен выбор системы РИО
            - предусмотренно сохранение данных в папку report_out, в соответствии с 
                выбранным расчетным месяцем , т.е. \report_out\YYYY\MM\...

    1.5. Опять же для удобства дальнейшего использования инструментов в процессе
        заполнения модулей, реализованы примеры использования указанных 
        Специальных функций\инструментов. Примеры в разделе 4.3.

## 2. Информация о проверяемом XML
    2.1. XML представляет собой файл с содержанием данных, соответствующих для передачи в соответствии с 
            - ФЗ от 05.07.2018 N 382, 
            - Формами (4.56) и требованиями Приказа Минэнерго РФ от 16.08.2019 № 865

    2.2. XML должен передаваться за прошедший месяц не позднее 25 числа текущего месяца.
    2.3. XML имеет сложную структуру и содержит 10 разделов. 
    2.2. XML в финансово расчетной системе имеет версию 2. 
    2.3. XML версии 2 построен на основе XML версии 1, также выгружаемом системой.   
    2.4. Отличие XML версии 2 от версии 1 заключается в том, что внутри XML все атрибуты 
        тэгов, поясняющие сущность передаваемых данных заменены на UUID.

## 3. Основная концепция проверки
    3.1. Проверка осуществляется по цепочке по следующей схеме 
        (стрелочки >> означают "проверяется на основе следующего"):

        XML версии 2 >> [XML версии 1 + mappingcol_xxx.csv + mappingstr_xxx.csv]  >>
        [mappingcol_xxx.csv + mappingstr_xxx.csv ] >> [набор метоописателей + скрипты]
        XML версии 1 >> отчеты из пакета "external_reports" + инфа из вэб интерфейса сис
        XML версии 1 >> отчеты из пакета "sistem_reports" (т.е. выгрузки из БД)

        Пояснения:
            3.1.1 В XML версии 1 вместо UUID - нормальные атрибуты тегов с поясняющей 
                информацией, т.е. в отношении какого договора, разрез и тп.
            3.1.2 mappingcol_xxx.csv + mappingstr_xxx.csv - это справочники соотнесения 
                UUID и атребутов тегов, которые заменяются в XML ver2. 
                Справочники получаем путем запуска на удаленной машине с VIP net 
                скрипта, переданного программистом АТС. 
            3.1.3 Набор метаописателей это большой набор xml, скаченных все тем же скриптом
                программитста АТС что формирует Справочники соотнесения. 
                Т.е. получается скрипт сперва скачивает метаописатели (около 9 гигабайт),
                а потом уже на основе них формирует два справочника, для колонок и для 
                строк.
    
    3.2. Для загрузки каждого отчета создается отдельный модуль. 
        Один модуль - должен содержать:
        - функцию загрузки одного конкретного отчета (XML или XLS или CSV) с return,
        - плюс возможно функции для корректировки данных этого отчета, 
        - плюс возможно импорт других других модулей (с данными ищ других отчетов)
        - плюс возможно функции для сверки данных этого модуля с данными импортируемых модулей
        - плюс сохранение резальтата сверки в XLS или CSV 
        
        Пояснение. 
            То есть модуль \public_reports\xml_to_minenergo_v2_cheks.py точно
        должен в себе содержать функцию по загрузке XML ver2, а также множество 
        импортов модулей с отчетами, содержащих эталонные данные, а также 
        функцию сверки и функцию вывода результата в XLS. 
            А вот модуль \external_reports\ext_br_itogovii_otchet.py будет в себе 
        сожержать только фукцию по загрузке отчете с return и всё.  

    3.3. Результат проверки, даже пустой, должен быть выгружен в файл XLS, либо CSV.
    
    3.4. Практически любая проверка это
        - получение DataFrame проверяемого отчета
        - получения DataFrame такого же по структуре и данным, полученного загрузкой 
            эталонных данных из отчетов коллег либо БД , либо дополнительных 
            справочников например с тарифами ФАС, либо т.п.
        - сравнение с помощью инструмента \project_tools\df_compare.py
        - сохранение рез-тов проверки инструментом \project_tools\df_save.py

## 4. Содержание шаблона
    4.1. имеет следующую струкутуру:
        - docs - (внутри должны быть подпапки - /YYYY/MM) папка для хранения нормативки, 
            регламентов, ТЗ и прочих документов, относящихся к месяцу расчета. 
        - experements - (внутри должны быть подпапки - /YYYY/MM) папка для хранения 
            файлов с данными, предназначенных для тестирования нововведений. 
            То есть при тестировании все необходимые XLS, XML или CSV скилываем туда. 
            А прм самом тестировании указываем этот путь. 
        - report_out - (внутри должны быть подпапки - /YYYY/MM) папка для выгрузки всех 
            отчетов, формируемых в ходе работы данного шаблона. Если необходмо сохранить 
            какой-либот отчет, то в файле config можно забрать 
            константу REPORT_OUT_PATH, которая уже будет в себе содержать путь к папке 
            report_out с учетом проверяемого года и месяца. 
            Способ применения константы REPORT_OUT_PATH можно посмотреть
            в уже написанных модулях, например в модуле xml_to_minenergo_cheks.py 
                "path = os.path.join(config.REPORT_OUT_PATH, "test_file.xlsx")"
                "save_df_into_xls(config.NAMES_XML_PARTS, transform_df_list, path)"
        - src папка с оновным кодом проверок. Иметтся следующая подструктура:
            - check_reports - проверяемые отчеты. В этом каталоге указаны модули 
                    загружающие проверяемые отчеты или отчеты, содержащие эталонные 
                    данные, XLS или XML. Для каждого отчета отдельный модуль.
                    В масках файлов указаны части имени самих файлов  
                - external_reports - внешние отчеты, присылаемые коллегами 
                - public_reports - публикумые отчеты  (здесь 2 штуки с UUID и без)
                - sistem_reports - отчеты систымы или выгрузки из ее БД
            - project_tools - инструменты для проверок
            - tests - тестирование кода если нужно, но можно и удалить
        - venv - каталог с установленными библиотеками 
        - также в корне миеются
            - config.py - здесь константы с датами, стендами и бд. 
                Также указаны параметры для подключения к БД. 
                Его надо создать копированием из config_template.py и вставив 
                личные параметры для доступа к БД АТС
            - requirements.txt - файл для загрузки необходимых библиотек
            - setup.cfg - настройки для автоформатеров кода black и flake8
            - .gitignore - указываем, что git-у не надо версионировать.

    4.2. Инструменты
        1. \project_tools\excel_parsing.py - Для загрузки XLS
        2. \project_tools\xml_parsing.py - Для загрузки XML
        3. \project_tools\coonection_db.py - Для выгрузки данных из БД
        4. \project_tools\df_compare.py - Для сравнения двух DataFrame (выд стр с разл)
        5. \project_tools\df_save.py - Сохранение DataFrame (сейчас там только в XLS)
        6. \project_tools\rounding_value.py - функции с округлением
        7. \project_tools\sql_query_list.py - список запросов SQL 
        8. \project_tools\references.py - любые справочники, сейчас только субъекты РФ
        9. \project_tools\directories_make.py - создание любого каталога в корне

    4.3. Примеры использования Специальных функций\ инструментов в следующих модулях:
        1. \external_reports\ext_mform_svnc_data.py (загрузка XML, сохр в XLS и тд)
        2. \external_reports\ext_rea_gtp_reference.py (загрузка XLS)
        3. \external_reports\ext_rea_uch_reference.py (загрузка XLS)
        4. \public_reports\xml_to_minenergo_cheks.py (загрузка итогового XML ver 1)
        5. \sistem_reports\br_from_db.py (загрузка данных из БД)

## 5. Установка
    5.1. Копируем проект к себе на локальную машину в отдельный каталог. 
        Желательно чтобы путь к проекту был без кириллических наименований

    5.2. Устанавливаем виртуальное окружение:
        - В консоли заходим в каталог проекта и создаем виртуальное окружение 
            следующими командами: 
                - cd /путь к коренвому каталогу проекта
                - python -m venv venv
        - создастся папка “venv” и в ней будут все базовые библиотеки и 
            сам интерпретатор python, но нужные библиотеки, указанных 
            в файле requirements.txtпридется дозагрузить так:
                в команде надо заменить логин и пароль своими учетными данными, 
                как для входа на физический компьютер
                - python -m pip install -r requirements.txt  --proxy=http://login:password@vm-squid:3128 --upgrade
        - В дальнейшем для установки библиотек по одной штуке надо заменить 
            в команде кусок “-r requirements.txt” на наименование библиотеки
        - Для корректно работы библиотеки cx_Oracle надо еще скопировать 
            отдельные библиотеки в подраздел:
            - от сюда \\Vm-dfr-files\департамент_финансовых_расчетов\
                        Отдел_расчета_цен_трансляции\_Общая\19. python\
                        2. Установка библиотек\
                        библиотеки клиента оракла (Client Library 64-bit - 19.12.0.0.0)
            - сюда \venv\Lib\site-packages

    5.3. Для проверки можно запустить функцию main в модуле run_check_xml_with_uuid.py
        должна появиться папка с файлом \report_out\2022\08\test_file.xlsx
    
## 6. Использование

    6.0.Перед работой с проектом необходимо обязательно активировать виртуальное
        окружение, а после окончания работы надо его деактивировать. 
        Это делается следующим образом:
        - активация осущ-ся командой в консоле: 'venv\Scripts\activate'
        - деактивация такой командой: deactivate
    
    Предлагается наполнять шаблон проверками в следующей последовательности:
    6.1. Прописать загрузки отчетов в каждый модуль разделов:
        - \external_reports
        - \sistem_reports
        - \public_reports

        Примечание: 
        6.1.1 Возможно полученный DataFrame будет в неподходящей структуре. 
            Например Объем потребления будет в одном столбце, ГТП потребления и 
            Генерации в двух разных столбцах, но в одной строчке. 
            Тут придется написать получение трех разных функций, 
                - первая для ГТП потребления, 
                - а вторая для ГТП генерации. 
                - а потом придется объединить эти два DF.
            В данном случае предполагается, что в модуле будут находится следующие
            функции: 
                - _get_fact_gtp_p() # первое нижнее подч-е означает техн-ю функц-ю
                - _get_fact_gtp_g()
                - get_cuncat_gtp_p_g() # результат будем забирать тольок из эт функц

        6.1.2 В эталонных отчетах коллег могут быть нюансы:
            - может быть несколько листов
            - может быть несколько файлов
            - пустые или не нужные строки
            - из отчетов нужны не все данные, а только нужное

        6.1.3 Помимо этого, могут быть и другие случаи, когда необходимо подправить
            полученный DataFrame. Можно также в этом же модуле написать техническую
            функцию аля _get и вызвать ее для корректировки DF в основной функц-ии.

    6.2. Далее предлагается уже работать в модулях раздела \public_reports. 
        6.2.1 К этому моменту например в модуле для XML ver 1 уже должна быть реализована
                функции загрузки данных. Функция вернет Список DataFrame, для каждого
                раздела, начиная с первого и заканчивая разделом 7.2

        6.2.2. Далее для сверки полученного списка DF из внешних отчетов необходимо 
            собрать такой же список DF. Для этого в текущий модуль импортируем 
            функции для зашрузки данных из соответствующих модулей. 
            Например для получения данных со справочником ГТП от РЭА 
            в модуле \xml_to_minenergo_cheks импортируем функцию  get_gtp_reference() 
            из модуля \ext_rea_gtp_reference.py (в \xml_to_minenergo_cheks это уже есть)

        6.2.3. Потом сравниваем два списка DF, можно с использованием цикла и \df_compare

        6.2.4. Результат сохранияем например в XLS с использ-ем \df_save        
                Примечание: все шаги +- описаны в модуле \xml_to_minenergo_cheks

